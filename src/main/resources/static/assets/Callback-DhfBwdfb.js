import{_ as O,u as M,i as r,m as V,a as u,o as d,d as e,a1 as R,t as v,z as E,b as i,w as m,e as N,ai as z,r as S,I as q,f as I,G as B,H,aj as J,a0 as L,g as j,E as F}from"./main-0j-tL-il.js";const G={class:"callback-container"},W={class:"callback-content"},K={key:0,class:"loading-section"},Q={class:"callback-message"},X={class:"progress-steps"},Y={key:1,class:"success-section"},Z={class:"success-icon"},ss={class:"countdown"},es={key:2,class:"error-section"},ts={class:"error-icon"},os={class:"error-message"},as={class:"error-actions"},ls={key:3,class:"debug-info"},ns={class:"debug-content"},rs={__name:"Callback",setup(is){const h=j(),T=J(),n=M(),g=r("正在验证登录凭证..."),f=r(""),k=r(!1),p=r(1),D=r(3),U=r(!1),y=r({}),w=r([]),t=o=>{w.value.push({id:Date.now(),time:new Date().toLocaleTimeString(),message:o})},C=async()=>{try{t("开始处理 SSO 回调");const o=T.query;y.value={...o},t(`URL 参数: ${JSON.stringify(o)}`);const s=o.ticket,a=o.return_url||o.redirect||"/";if(!s)throw new Error("未收到有效的登录凭证 (ticket)");t(`Ticket: ${s.substring(0,20)}...`),t(`返回地址: ${a}`),p.value=1,g.value="正在验证登录凭证...";const _=await L.post("http://localhost:8081/sso/validate",null,{params:{ticket:s}});if(_.data.code!==200)throw new Error(_.data.message||"Ticket验证失败");const c=_.data.data;t(`Ticket验证成功，用户: ${c.username}`),p.value=2,g.value="正在处理本地登录...",n.userInfo=c,n.roles=c.roles||[],n.primaryRole=$(c.roles||[]);const b="sso_client_"+s.substring(0,8)+"_"+Date.now();n.setToken(b);try{(await L.post("/sso/establish-session",{ticket:s,token:b,userInfo:c})).data.code===200?t("本地会话建立成功"):t("本地会话建立失败，但继续处理")}catch(l){t("本地会话建立失败，但继续处理: "+l.message)}t(`本地用户信息已设置，角色: ${n.primaryRole}`),p.value=3,g.value="登录成功，正在跳转...",k.value=!0,t(`准备跳转到: ${a}`),setTimeout(()=>{if(a&&a!=="/"&&a!==window.location.origin+"/")t(`跳转到原始URL: ${a}`),a.startsWith("http")?window.location.href=a:h.push(a);else{const l=x(n.primaryRole);t(`跳转到仪表板: ${l}`),h.push(l)}},1e3)}catch(o){console.error("SSO 回调处理失败:",o),t(`错误: ${o.message}`),f.value=o.message||"SSO 登录处理失败",n.clearAuth(),F.error(f.value)}},A=()=>{t("用户点击重新登录"),n.redirectToLogin()},P=()=>{t("用户点击返回首页"),h.push("/")},$=o=>{const s=["ADMIN","AIRLINE_USER","ENTERPRISE_USER","PERSONAL_USER"];for(const a of s)if(o.includes(a))return a;return"PERSONAL_USER"},x=o=>({ADMIN:"/dashboard/admin",PERSONAL_USER:"/dashboard/personal",ENTERPRISE_USER:"/dashboard/enterprise",AIRLINE_USER:"/dashboard/airline"})[o]||"/dashboard/personal";return V(()=>{t("Callback 页面已挂载"),setTimeout(()=>{C()},500)}),(o,s)=>{const a=S("el-icon"),_=S("el-button"),c=S("el-collapse-item"),b=S("el-collapse");return d(),u("div",G,[e("div",W,[!f.value&&!k.value?(d(),u("div",K,[s[3]||(s[3]=e("div",{class:"loading-spinner"},[e("div",{class:"spinner"})],-1)),s[4]||(s[4]=e("h2",{class:"callback-title"},"正在处理登录信息...",-1)),e("p",Q,v(g.value),1),e("div",X,[e("div",{class:E(["step",{active:p.value>=1}])},s[0]||(s[0]=[e("div",{class:"step-icon"},"1",-1),e("div",{class:"step-text"},"验证凭证",-1)]),2),e("div",{class:E(["step",{active:p.value>=2}])},s[1]||(s[1]=[e("div",{class:"step-icon"},"2",-1),e("div",{class:"step-text"},"获取用户信息",-1)]),2),e("div",{class:E(["step",{active:p.value>=3}])},s[2]||(s[2]=[e("div",{class:"step-icon"},"3",-1),e("div",{class:"step-text"},"跳转页面",-1)]),2)])])):R("",!0),k.value?(d(),u("div",Y,[e("div",Z,[i(a,{size:"64",color:"#67c23a"},{default:m(()=>[i(N(z))]),_:1})]),s[5]||(s[5]=e("h2",{class:"success-title"},"登录成功！",-1)),s[6]||(s[6]=e("p",{class:"success-message"},"正在跳转到目标页面...",-1)),e("div",ss,[e("span",null,v(D.value)+" 秒后自动跳转",1)])])):R("",!0),f.value?(d(),u("div",es,[e("div",ts,[i(a,{size:"64",color:"#f56c6c"},{default:m(()=>[i(N(q))]),_:1})]),s[9]||(s[9]=e("h2",{class:"error-title"},"登录失败",-1)),e("p",os,v(f.value),1),e("div",as,[i(_,{type:"primary",onClick:A},{default:m(()=>s[7]||(s[7]=[I(" 重新登录 ",-1)])),_:1,__:[7]}),i(_,{onClick:P},{default:m(()=>s[8]||(s[8]=[I(" 返回首页 ",-1)])),_:1,__:[8]})])])):R("",!0),U.value?(d(),u("div",ls,[i(b,null,{default:m(()=>[i(c,{title:"调试信息",name:"debug"},{default:m(()=>[e("div",ns,[s[10]||(s[10]=e("p",null,[e("strong",null,"URL 参数:")],-1)),e("pre",null,v(JSON.stringify(y.value,null,2)),1),s[11]||(s[11]=e("p",null,[e("strong",null,"处理步骤:")],-1)),e("ul",null,[(d(!0),u(B,null,H(w.value,l=>(d(),u("li",{key:l.id}," ["+v(l.time)+"] "+v(l.message),1))),128))])])]),_:1})]),_:1})])):R("",!0)])])}}},us=O(rs,[["__scopeId","data-v-3b93fc6d"]]);export{us as default};
