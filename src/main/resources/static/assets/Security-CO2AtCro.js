import{_ as ee,i as g,Y as U,m as se,a as f,o as u,b as t,w as a,r as c,f as w,e as p,B as te,$ as x,d as o,l as oe,s as ae,a1 as A,G as q,H as $,q as le,F as ne,a0 as m,E as n,n as z,p as re,t as _,a2 as ie}from"./main-0j-tL-il.js";const de={class:"security-container"},ce={class:"card-header"},ue={class:"card-header"},pe={class:"security-settings"},me={class:"setting-item"},_e={class:"setting-action"},ge={class:"setting-item"},fe={class:"setting-action"},we={class:"setting-item"},ye={class:"setting-action"},ve={class:"card-header"},Pe={class:"devices-list"},he={class:"device-icon"},Ve={class:"device-info"},be={class:"device-details"},ke={class:"device-status"},Le={class:"device-actions"},Ce={key:0,class:"empty-devices"},Fe={class:"card-header"},Ne={class:"log-content"},Ee={class:"log-ip"},Me={key:0,class:"empty-logs"},xe={__name:"Security",setup(Ae){const h=g(),V=g(!1),b=g(!1),k=g(!1),L=g(!1),r=U({oldPassword:"",newPassword:"",confirmPassword:""}),i=U({twoFactorEnabled:!1,loginNotification:!0,abnormalLoginProtection:!0}),C=g([]),F=g([]),I={oldPassword:[{required:!0,message:"请输入当前密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度不能少于6位",trigger:"blur"},{pattern:/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d@$!%*?&]{6,}$/,message:"密码必须包含大小写字母和数字",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(s,e,d)=>{e!==r.newPassword?d(new Error("两次输入的密码不一致")):d()},trigger:"blur"}]},R=async()=>{try{await h.value.validate(),V.value=!0;const s=await m.put("/api/user/change-password",{oldPassword:r.oldPassword,newPassword:r.newPassword});s.data.code===200?(n.success("密码修改成功"),S()):n.error(s.data.message||"密码修改失败")}catch(s){console.error("修改密码失败:",s),n.error("密码修改失败")}finally{V.value=!1}},S=()=>{var s;r.oldPassword="",r.newPassword="",r.confirmPassword="",(s=h.value)==null||s.clearValidate()},Z=async s=>{try{b.value=!0;const e=await m.put("/api/user/two-factor",{enabled:s});e.data.code===200?n.success(s?"双因素认证已开启":"双因素认证已关闭"):(i.twoFactorEnabled=!s,n.error(e.data.message||"设置失败"))}catch{i.twoFactorEnabled=!s,n.error("设置失败")}finally{b.value=!1}},j=async s=>{try{k.value=!0;const e=await m.put("/api/user/login-notification",{enabled:s});e.data.code===200?n.success(s?"登录通知已开启":"登录通知已关闭"):(i.loginNotification=!s,n.error(e.data.message||"设置失败"))}catch{i.loginNotification=!s,n.error("设置失败")}finally{k.value=!1}},G=async s=>{try{L.value=!0;const e=await m.put("/api/user/abnormal-protection",{enabled:s});e.data.code===200?n.success(s?"异常登录保护已开启":"异常登录保护已关闭"):(i.abnormalLoginProtection=!s,n.error(e.data.message||"设置失败"))}catch{i.abnormalLoginProtection=!s,n.error("设置失败")}finally{L.value=!1}},H=s=>({desktop:"Monitor",mobile:"Iphone",tablet:"Tablet",unknown:"Monitor"})[s]||"Monitor",O=async s=>{try{await ie.confirm("确定要移除此设备吗？","确认操作",{type:"warning"});const e=await m.delete(`/api/user/device/${s}`);e.data.code===200?(n.success("设备已移除"),N()):n.error(e.data.message||"移除失败")}catch(e){e!=="cancel"&&n.error("移除失败")}},N=async()=>{try{const s=await m.get("/api/user/devices");s.data.code===200&&(C.value=s.data.data||[])}catch(s){console.error("获取设备列表失败:",s)}},B=async()=>{try{const s=await m.get("/api/user/security-logs");s.data.code===200&&(F.value=s.data.data||[])}catch(s){console.error("获取安全日志失败:",s)}},Y=s=>({login:"success",logout:"info",password_change:"warning",security_alert:"danger"})[s]||"info",J=async()=>{try{const s=await m.get("/api/user/security-settings");s.data.code===200&&Object.assign(i,s.data.data)}catch(s){console.error("获取安全设置失败:",s)}};return se(()=>{J(),N(),B()}),(s,e)=>{const d=c("el-icon"),E=c("el-input"),v=c("el-form-item"),y=c("el-button"),K=c("el-form"),P=c("el-card"),M=c("el-switch"),D=c("el-divider"),Q=c("el-tag"),T=c("el-empty"),W=c("el-timeline-item"),X=c("el-timeline");return u(),f("div",de,[t(P,{class:"security-card"},{header:a(()=>[o("div",ce,[t(d,null,{default:a(()=>[t(p(oe))]),_:1}),e[6]||(e[6]=o("span",null,"修改密码",-1))])]),default:a(()=>[t(K,{ref_key:"passwordFormRef",ref:h,model:r,rules:I,"label-width":"120px",class:"password-form"},{default:a(()=>[t(v,{label:"当前密码",prop:"oldPassword"},{default:a(()=>[t(E,{modelValue:r.oldPassword,"onUpdate:modelValue":e[0]||(e[0]=l=>r.oldPassword=l),type:"password",placeholder:"请输入当前密码","show-password":""},null,8,["modelValue"])]),_:1}),t(v,{label:"新密码",prop:"newPassword"},{default:a(()=>[t(E,{modelValue:r.newPassword,"onUpdate:modelValue":e[1]||(e[1]=l=>r.newPassword=l),type:"password",placeholder:"请输入新密码","show-password":""},null,8,["modelValue"])]),_:1}),t(v,{label:"确认新密码",prop:"confirmPassword"},{default:a(()=>[t(E,{modelValue:r.confirmPassword,"onUpdate:modelValue":e[2]||(e[2]=l=>r.confirmPassword=l),type:"password",placeholder:"请再次输入新密码","show-password":""},null,8,["modelValue"])]),_:1}),t(v,null,{default:a(()=>[t(y,{type:"primary",onClick:R,loading:V.value},{default:a(()=>[t(d,null,{default:a(()=>[t(p(te))]),_:1}),e[7]||(e[7]=w(" 修改密码 ",-1))]),_:1,__:[7]},8,["loading"]),t(y,{onClick:S},{default:a(()=>[t(d,null,{default:a(()=>[t(p(x))]),_:1}),e[8]||(e[8]=w(" 重置 ",-1))]),_:1,__:[8]})]),_:1})]),_:1},8,["model"])]),_:1}),t(P,{class:"security-card"},{header:a(()=>[o("div",ue,[t(d,null,{default:a(()=>[t(p(ae))]),_:1}),e[9]||(e[9]=o("span",null,"安全设置",-1))])]),default:a(()=>[o("div",pe,[o("div",me,[e[10]||(e[10]=o("div",{class:"setting-info"},[o("h4",null,"双因素认证"),o("p",null,"为您的账号添加额外的安全保护")],-1)),o("div",_e,[t(M,{modelValue:i.twoFactorEnabled,"onUpdate:modelValue":e[3]||(e[3]=l=>i.twoFactorEnabled=l),onChange:Z,loading:b.value},null,8,["modelValue","loading"])])]),t(D),o("div",ge,[e[11]||(e[11]=o("div",{class:"setting-info"},[o("h4",null,"登录通知"),o("p",null,"当有新设备登录时发送邮件通知")],-1)),o("div",fe,[t(M,{modelValue:i.loginNotification,"onUpdate:modelValue":e[4]||(e[4]=l=>i.loginNotification=l),onChange:j,loading:k.value},null,8,["modelValue","loading"])])]),t(D),o("div",we,[e[12]||(e[12]=o("div",{class:"setting-info"},[o("h4",null,"异常登录保护"),o("p",null,"检测到异常登录时自动锁定账号")],-1)),o("div",ye,[t(M,{modelValue:i.abnormalLoginProtection,"onUpdate:modelValue":e[5]||(e[5]=l=>i.abnormalLoginProtection=l),onChange:G,loading:L.value},null,8,["modelValue","loading"])])])])]),_:1}),t(P,{class:"security-card"},{header:a(()=>[o("div",ve,[t(d,null,{default:a(()=>[t(p(le))]),_:1}),e[14]||(e[14]=o("span",null,"登录设备",-1)),t(y,{type:"text",size:"small",onClick:N,style:{"margin-left":"auto"}},{default:a(()=>[t(d,null,{default:a(()=>[t(p(x))]),_:1}),e[13]||(e[13]=w(" 刷新 ",-1))]),_:1,__:[13]})])]),default:a(()=>[o("div",Pe,[(u(!0),f(q,null,$(C.value,l=>(u(),f("div",{key:l.id,class:"device-item"},[o("div",he,[t(d,{size:"24"},{default:a(()=>[(u(),z(re(H(l.deviceType))))]),_:2},1024)]),o("div",Ve,[o("h4",null,_(l.deviceName),1),o("p",null,_(l.location)+" · "+_(l.lastActiveTime),1),o("p",be,_(l.userAgent),1)]),o("div",ke,[t(Q,{type:l.isActive?"success":"info"},{default:a(()=>[w(_(l.isActive?"当前设备":"离线"),1)]),_:2},1032,["type"])]),o("div",Le,[l.isActive?A("",!0):(u(),z(y,{key:0,type:"danger",size:"small",onClick:ze=>O(l.id)},{default:a(()=>e[15]||(e[15]=[w(" 移除 ",-1)])),_:2,__:[15]},1032,["onClick"]))])]))),128)),C.value.length===0?(u(),f("div",Ce,[t(T,{description:"暂无登录设备记录","image-size":80})])):A("",!0)])]),_:1}),t(P,{class:"security-card"},{header:a(()=>[o("div",Fe,[t(d,null,{default:a(()=>[t(p(ne))]),_:1}),e[17]||(e[17]=o("span",null,"安全日志",-1)),t(y,{type:"text",size:"small",onClick:B,style:{"margin-left":"auto"}},{default:a(()=>[t(d,null,{default:a(()=>[t(p(x))]),_:1}),e[16]||(e[16]=w(" 刷新 ",-1))]),_:1,__:[16]})])]),default:a(()=>[t(X,null,{default:a(()=>[(u(!0),f(q,null,$(F.value,l=>(u(),z(W,{key:l.id,timestamp:l.time,type:Y(l.type)},{default:a(()=>[o("div",Ne,[o("h4",null,_(l.title),1),o("p",null,_(l.description),1),o("span",Ee,"IP: "+_(l.ipAddress),1)])]),_:2},1032,["timestamp","type"]))),128))]),_:1}),F.value.length===0?(u(),f("div",Me,[t(T,{description:"暂无安全日志","image-size":80})])):A("",!0)]),_:1})])}}},Be=ee(xe,[["__scopeId","data-v-b864d1de"]]);export{Be as default};
