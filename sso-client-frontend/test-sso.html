<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSO系统完整测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-info { background: #17a2b8; color: white; }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background: #f8f9fa;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .test-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        .test-item h4 {
            margin-top: 0;
            color: #495057;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.pass { background: #d4edda; color: #155724; }
        .status.fail { background: #f8d7da; color: #721c24; }
        .status.pending { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>🚀 SSO单点登录系统完整测试</h1>

    <div class="test-section">
        <h3>🔧 环境信息</h3>
        <div id="envInfo" class="result info"></div>
    </div>

    <div class="test-section">
        <h3>📋 核心功能测试</h3>
        <div class="test-grid">
            <div class="test-item">
                <h4>1. 未登录跳转测试</h4>
                <button class="btn btn-primary" onclick="testUnauthRedirect()">测试未登录跳转</button>
                <button class="btn btn-info" onclick="testProtectedAccess()">测试保护页面访问</button>
                <div id="redirectResult" class="result"></div>
            </div>

            <div class="test-item">
                <h4>2. SSO登录流程测试</h4>
                <button class="btn btn-success" onclick="testSsoLogin()">模拟SSO登录</button>
                <button class="btn btn-info" onclick="testCallback()">测试回调处理</button>
                <div id="loginResult" class="result"></div>
            </div>

            <div class="test-item">
                <h4>3. 会话同步测试</h4>
                <button class="btn btn-warning" onclick="testSessionSync()">测试会话同步</button>
                <button class="btn btn-info" onclick="testMultiTabLogin()">测试多标签登录</button>
                <div id="sessionResult" class="result"></div>
            </div>

            <div class="test-item">
                <h4>4. 单点注销测试</h4>
                <button class="btn btn-danger" onclick="testSlo()">测试单点注销</button>
                <button class="btn btn-info" onclick="testLogoutCallback()">测试注销回调</button>
                <div id="logoutResult" class="result"></div>
            </div>

            <div class="test-item">
                <h4>5. 多用户类型测试</h4>
                <button class="btn btn-primary" onclick="testUserTypes()">测试用户类型</button>
                <button class="btn btn-info" onclick="testRolePermissions()">测试角色权限</button>
                <div id="userTypeResult" class="result"></div>
            </div>

            <div class="test-item">
                <h4>6. Token管理测试</h4>
                <button class="btn btn-warning" onclick="testTokenManagement()">测试Token管理</button>
                <button class="btn btn-info" onclick="testTokenExpiry()">测试Token过期</button>
                <div id="tokenResult" class="result"></div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h3>🧹 维护工具</h3>
        <button class="btn btn-danger" onclick="clearAllAuth()">清除所有认证状态</button>
        <button class="btn btn-warning" onclick="clearCache()">清除缓存</button>
        <button class="btn btn-info" onclick="showDebugInfo()">显示调试信息</button>
        <div id="maintenanceResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>📊 测试报告</h3>
        <div id="testReport" class="result info"></div>
    </div>

    <script>
        // 测试状态管理
        let testResults = {
            unauthRedirect: { status: 'pending', message: '未测试' },
            ssoLogin: { status: 'pending', message: '未测试' },
            sessionSync: { status: 'pending', message: '未测试' },
            slo: { status: 'pending', message: '未测试' },
            userTypes: { status: 'pending', message: '未测试' },
            tokenManagement: { status: 'pending', message: '未测试' }
        };

        // 简单的AJAX请求函数
        async function request(method, url, data = null) {
            const config = {
                method: method,
                credentials: 'include',
                headers: {}
            };

            if (data) {
                config.headers['Content-Type'] = 'application/json';
                config.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(url, config);
                return await response.json();
            } catch (error) {
                return { code: 500, message: error.message };
            }
        }

        // 显示环境信息
        function showEnvInfo() {
            const env = {
                frontend: {
                    url: window.location.origin,
                    userAgent: navigator.userAgent,
                    cookies: document.cookie,
                    localStorage: Object.keys(localStorage).length
                },
                backend: {
                    clientUrl: 'http://localhost:8082',
                    ssoUrl: 'http://localhost:8081'
                },
                expectedPorts: {
                    frontend: 5137,
                    clientBackend: 8082,
                    ssoServer: 8081
                }
            };

            document.getElementById('envInfo').textContent = JSON.stringify(env, null, 2);
        }

        // 测试未登录跳转
        async function testUnauthRedirect() {
            updateTestResult('unauthRedirect', 'running', '正在测试...');
            try {
                // 尝试访问受保护页面
                const response = await request('GET', '/dashboard/admin');
                if (response.code === 401 || response.code === 302) {
                    updateTestResult('unauthRedirect', 'pass', '✅ 未登录时正确阻止访问');
                } else {
                    updateTestResult('unauthRedirect', 'fail', '❌ 未登录访问未被阻止');
                }
            } catch (error) {
                if (error.message.includes('401') || error.message.includes('302')) {
                    updateTestResult('unauthRedirect', 'pass', '✅ 未登录时正确阻止访问');
                } else {
                    updateTestResult('unauthRedirect', 'fail', '❌ 访问控制失败: ' + error.message);
                }
            }
        }

        // 测试保护页面访问
        async function testProtectedAccess() {
            try {
                // 测试不同角色的仪表板访问
                const dashboards = [
                    { path: '/dashboard/admin', role: 'ADMIN' },
                    { path: '/dashboard/personal', role: 'PERSONAL_USER' },
                    { path: '/dashboard/enterprise', role: 'ENTERPRISE_USER' },
                    { path: '/dashboard/airline', role: 'AIRLINE_USER' }
                ];

                let result = '';
                for (const dash of dashboards) {
                    const response = await request('GET', dash.path);
                    result += `📍 ${dash.path} (${dash.role}): ${response.code === 401 ? '需要登录 ✅' : '无需登录 ⚠️'}\n`;
                }

                document.getElementById('redirectResult').className = 'result info';
                document.getElementById('redirectResult').textContent = result;
            } catch (error) {
                document.getElementById('redirectResult').className = 'result error';
                document.getElementById('redirectResult').textContent = '❌ 测试失败: ' + error.message;
            }
        }

        // 测试SSO登录
        function testSsoLogin() {
            const returnUrl = encodeURIComponent(window.location.href);
            const ssoUrl = `http://localhost:8081/sso/auth?redirect=${encodeURIComponent(window.location.origin + '/callback')}&return_url=${returnUrl}`;

            updateTestResult('ssoLogin', 'running', '正在测试...');

            document.getElementById('loginResult').className = 'result success';
            document.getElementById('loginResult').textContent = `🔗 SSO登录URL: ${ssoUrl}\n\n请在新标签页打开上述URL进行测试`;

            updateTestResult('ssoLogin', 'pass', '✅ SSO登录URL生成正确');
        }

        // 测试回调处理
        async function testCallback() {
            try {
                // 模拟ticket验证
                const mockTicket = 'test_ticket_' + Date.now();
                const response = await request('POST', 'http://localhost:8081/sso/validate', null, {
                    params: { ticket: mockTicket }
                });

                if (response.code === 200) {
                    document.getElementById('loginResult').className = 'result success';
                    document.getElementById('loginResult').textContent = '✅ Ticket验证接口正常';
                } else {
                    document.getElementById('loginResult').className = 'result warning';
                    document.getElementById('loginResult').textContent = '⚠️ Ticket验证返回: ' + response.message;
                }
            } catch (error) {
                document.getElementById('loginResult').className = 'result error';
                document.getElementById('loginResult').textContent = '❌ 回调测试失败: ' + error.message;
            }
        }

        // 测试会话同步
        async function testSessionSync() {
            updateTestResult('sessionSync', 'running', '正在测试...');
            try {
                const response = await request('GET', '/sso/check-login');
                if (response.code === 200) {
                    updateTestResult('sessionSync', 'pass', '✅ 会话状态检查正常');
                } else {
                    updateTestResult('sessionSync', 'fail', '❌ 会话状态检查失败');
                }
            } catch (error) {
                updateTestResult('sessionSync', 'fail', '❌ 会话同步测试失败: ' + error.message);
            }
        }

        // 测试多标签登录
        function testMultiTabLogin() {
            const message = `🔄 多标签登录测试说明:
1. 在新标签页打开: http://localhost:5137
2. 在新标签页中登录
3. 回到当前标签页，点击"测试会话同步"
4. 观察是否自动获取到登录状态

当前标签页应能检测到其他标签页的登录状态`;
            document.getElementById('sessionResult').className = 'result info';
            document.getElementById('sessionResult').textContent = message;
        }

        // 测试单点注销
        async function testSlo() {
            updateTestResult('slo', 'running', '正在测试...');
            try {
                const response = await request('POST', '/sso/logout');
                if (response.code === 200) {
                    updateTestResult('slo', 'pass', '✅ 单点注销接口正常');
                } else {
                    updateTestResult('slo', 'fail', '❌ 单点注销失败: ' + response.message);
                }
            } catch (error) {
                updateTestResult('slo', 'fail', '❌ 单点注销测试失败: ' + error.message);
            }
        }

        // 测试用户类型
        async function testUserTypes() {
            updateTestResult('userTypes', 'running', '正在测试...');
            try {
                // 测试角色权限获取
                const response = await request('GET', '/api/role/current');
                if (response.code === 200) {
                    const roles = response.data.roles || [];
                    const primaryRole = response.data.primaryRole || 'unknown';

                    let result = `当前用户角色: ${JSON.stringify(roles)}\n`;
                    result += `主要角色: ${primaryRole}\n\n`;

                    // 检查角色对应的仪表板路径
                    const roleDashboards = {
                        'ADMIN': '/dashboard/admin',
                        'PERSONAL_USER': '/dashboard/personal',
                        'ENTERPRISE_USER': '/dashboard/enterprise',
                        'AIRLINE_USER': '/dashboard/airline'
                    };

                    for (const role of roles) {
                        const dashboard = roleDashboards[role];
                        result += `📍 ${role} → ${dashboard || '无对应仪表板'}\n`;
                    }

                    updateTestResult('userTypes', 'pass', result);
                } else {
                    updateTestResult('userTypes', 'fail', '❌ 获取角色信息失败');
                }
            } catch (error) {
                updateTestResult('userTypes', 'fail', '❌ 用户类型测试失败: ' + error.message);
            }
        }

        // 测试角色权限
        async function testRolePermissions() {
            try {
                const permissions = [
                    'user:profile:view',
                    'system:user:view',
                    'enterprise:info:view',
                    'airline:flight:view'
                ];

                let result = '权限检查结果:\n\n';
                for (const perm of permissions) {
                    const response = await request('POST', '/api/role/check-permission', { permission: perm });
                    const hasPerm = response.code === 200 && response.data === true;
                    result += `${hasPerm ? '✅' : '❌'} ${perm}\n`;
                }

                document.getElementById('userTypeResult').className = 'result info';
                document.getElementById('userTypeResult').textContent = result;
            } catch (error) {
                document.getElementById('userTypeResult').className = 'result error';
                document.getElementById('userTypeResult').textContent = '❌ 权限检查失败: ' + error.message;
            }
        }

        // 测试Token管理
        async function testTokenManagement() {
            updateTestResult('tokenManagement', 'running', '正在测试...');
            try {
                // 测试Token验证
                const verifyResponse = await request('GET', '/sso/verify');
                if (verifyResponse.code === 200) {
                    updateTestResult('tokenManagement', 'pass', '✅ Token验证正常');
                } else {
                    updateTestResult('tokenManagement', 'fail', '❌ Token验证失败');
                }
            } catch (error) {
                updateTestResult('tokenManagement', 'fail', '❌ Token管理测试失败: ' + error.message);
            }
        }

        // 测试Token过期
        function testTokenExpiry() {
            const message = `⏰ Token过期测试说明:
1. 登录系统
2. 等待Token过期时间（默认30天）
3. 尝试访问受保护资源
4. 观察是否自动跳转登录

或者手动修改Token过期时间进行测试`;
            document.getElementById('tokenResult').className = 'result info';
            document.getElementById('tokenResult').textContent = message;
        }

        // 清除所有认证状态
        function clearAllAuth() {
            try {
                localStorage.clear();
                document.cookie.split(";").forEach(function(c) {
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                });
                document.getElementById('maintenanceResult').className = 'result success';
                document.getElementById('maintenanceResult').textContent = '✅ 所有认证状态已清除';
            } catch (error) {
                document.getElementById('maintenanceResult').className = 'result error';
                document.getElementById('maintenanceResult').textContent = '❌ 清除失败: ' + error.message;
            }
        }

        // 清除缓存
        async function clearCache() {
            try {
                // 清除Redis缓存（需要后端支持）
                const response = await request('POST', '/api/cache/clear');
                if (response.code === 200) {
                    document.getElementById('maintenanceResult').className = 'result success';
                    document.getElementById('maintenanceResult').textContent = '✅ 缓存已清除';
                } else {
                    document.getElementById('maintenanceResult').className = 'result warning';
                    document.getElementById('maintenanceResult').textContent = '⚠️ 缓存清除接口未实现';
                }
            } catch (error) {
                document.getElementById('maintenanceResult').className = 'result error';
                document.getElementById('maintenanceResult').textContent = '❌ 缓存清除失败: ' + error.message;
            }
        }

        // 显示调试信息
        function showDebugInfo() {
            const debug = {
                timestamp: new Date().toISOString(),
                url: window.location.href,
                cookies: document.cookie,
                localStorage: Object.keys(localStorage),
                sessionStorage: Object.keys(sessionStorage),
                userAgent: navigator.userAgent,
                testResults: testResults
            };

            document.getElementById('maintenanceResult').className = 'result info';
            document.getElementById('maintenanceResult').textContent = JSON.stringify(debug, null, 2);
        }

        // 更新测试结果
        function updateTestResult(testName, status, message) {
            testResults[testName] = { status, message };
            updateTestReport();
        }

        // 更新测试报告
        function updateTestReport() {
            let report = '📊 SSO系统测试报告\n\n';
            report += '测试时间: ' + new Date().toLocaleString() + '\n\n';

            const statusMap = {
                pass: '✅ 通过',
                fail: '❌ 失败',
                pending: '⏳ 待测试',
                running: '🔄 运行中'
            };

            for (const [testName, result] of Object.entries(testResults)) {
                const statusText = statusMap[result.status] || result.status;
                report += `${testName}: ${statusText}\n`;
                if (result.message) {
                    report += `   ${result.message}\n`;
                }
                report += '\n';
            }

            document.getElementById('testReport').textContent = report;
        }

        // 页面初始化
        window.onload = function() {
            showEnvInfo();
            updateTestReport();
        };

        // 定期检查登录状态
        setInterval(async () => {
            if (document.getElementById('sessionResult').classList.contains('success')) {
                await testSessionSync();
            }
        }, 5000); // 每5秒检查一次
    </script>
</body>
</html>
