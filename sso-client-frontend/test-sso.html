<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSOç³»ç»Ÿå®Œæ•´æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-info { background: #17a2b8; color: white; }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            background: #f8f9fa;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .test-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        .test-item h4 {
            margin-top: 0;
            color: #495057;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.pass { background: #d4edda; color: #155724; }
        .status.fail { background: #f8d7da; color: #721c24; }
        .status.pending { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>ğŸš€ SSOå•ç‚¹ç™»å½•ç³»ç»Ÿå®Œæ•´æµ‹è¯•</h1>

    <div class="test-section">
        <h3>ğŸ”§ ç¯å¢ƒä¿¡æ¯</h3>
        <div id="envInfo" class="result info"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“‹ æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•</h3>
        <div class="test-grid">
            <div class="test-item">
                <h4>1. æœªç™»å½•è·³è½¬æµ‹è¯•</h4>
                <button class="btn btn-primary" onclick="testUnauthRedirect()">æµ‹è¯•æœªç™»å½•è·³è½¬</button>
                <button class="btn btn-info" onclick="testProtectedAccess()">æµ‹è¯•ä¿æŠ¤é¡µé¢è®¿é—®</button>
                <div id="redirectResult" class="result"></div>
            </div>

            <div class="test-item">
                <h4>2. SSOç™»å½•æµç¨‹æµ‹è¯•</h4>
                <button class="btn btn-success" onclick="testSsoLogin()">æ¨¡æ‹ŸSSOç™»å½•</button>
                <button class="btn btn-info" onclick="testCallback()">æµ‹è¯•å›è°ƒå¤„ç†</button>
                <div id="loginResult" class="result"></div>
            </div>

            <div class="test-item">
                <h4>3. ä¼šè¯åŒæ­¥æµ‹è¯•</h4>
                <button class="btn btn-warning" onclick="testSessionSync()">æµ‹è¯•ä¼šè¯åŒæ­¥</button>
                <button class="btn btn-info" onclick="testMultiTabLogin()">æµ‹è¯•å¤šæ ‡ç­¾ç™»å½•</button>
                <div id="sessionResult" class="result"></div>
            </div>

            <div class="test-item">
                <h4>4. å•ç‚¹æ³¨é”€æµ‹è¯•</h4>
                <button class="btn btn-danger" onclick="testSlo()">æµ‹è¯•å•ç‚¹æ³¨é”€</button>
                <button class="btn btn-info" onclick="testLogoutCallback()">æµ‹è¯•æ³¨é”€å›è°ƒ</button>
                <div id="logoutResult" class="result"></div>
            </div>

            <div class="test-item">
                <h4>5. å¤šç”¨æˆ·ç±»å‹æµ‹è¯•</h4>
                <button class="btn btn-primary" onclick="testUserTypes()">æµ‹è¯•ç”¨æˆ·ç±»å‹</button>
                <button class="btn btn-info" onclick="testRolePermissions()">æµ‹è¯•è§’è‰²æƒé™</button>
                <div id="userTypeResult" class="result"></div>
            </div>

            <div class="test-item">
                <h4>6. Tokenç®¡ç†æµ‹è¯•</h4>
                <button class="btn btn-warning" onclick="testTokenManagement()">æµ‹è¯•Tokenç®¡ç†</button>
                <button class="btn btn-info" onclick="testTokenExpiry()">æµ‹è¯•Tokenè¿‡æœŸ</button>
                <div id="tokenResult" class="result"></div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ§¹ ç»´æŠ¤å·¥å…·</h3>
        <button class="btn btn-danger" onclick="clearAllAuth()">æ¸…é™¤æ‰€æœ‰è®¤è¯çŠ¶æ€</button>
        <button class="btn btn-warning" onclick="clearCache()">æ¸…é™¤ç¼“å­˜</button>
        <button class="btn btn-info" onclick="showDebugInfo()">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
        <div id="maintenanceResult" class="result"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“Š æµ‹è¯•æŠ¥å‘Š</h3>
        <div id="testReport" class="result info"></div>
    </div>

    <script>
        // æµ‹è¯•çŠ¶æ€ç®¡ç†
        let testResults = {
            unauthRedirect: { status: 'pending', message: 'æœªæµ‹è¯•' },
            ssoLogin: { status: 'pending', message: 'æœªæµ‹è¯•' },
            sessionSync: { status: 'pending', message: 'æœªæµ‹è¯•' },
            slo: { status: 'pending', message: 'æœªæµ‹è¯•' },
            userTypes: { status: 'pending', message: 'æœªæµ‹è¯•' },
            tokenManagement: { status: 'pending', message: 'æœªæµ‹è¯•' }
        };

        // ç®€å•çš„AJAXè¯·æ±‚å‡½æ•°
        async function request(method, url, data = null) {
            const config = {
                method: method,
                credentials: 'include',
                headers: {}
            };

            if (data) {
                config.headers['Content-Type'] = 'application/json';
                config.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(url, config);
                return await response.json();
            } catch (error) {
                return { code: 500, message: error.message };
            }
        }

        // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        function showEnvInfo() {
            const env = {
                frontend: {
                    url: window.location.origin,
                    userAgent: navigator.userAgent,
                    cookies: document.cookie,
                    localStorage: Object.keys(localStorage).length
                },
                backend: {
                    clientUrl: 'http://localhost:8082',
                    ssoUrl: 'http://localhost:8081'
                },
                expectedPorts: {
                    frontend: 5137,
                    clientBackend: 8082,
                    ssoServer: 8081
                }
            };

            document.getElementById('envInfo').textContent = JSON.stringify(env, null, 2);
        }

        // æµ‹è¯•æœªç™»å½•è·³è½¬
        async function testUnauthRedirect() {
            updateTestResult('unauthRedirect', 'running', 'æ­£åœ¨æµ‹è¯•...');
            try {
                // å°è¯•è®¿é—®å—ä¿æŠ¤é¡µé¢
                const response = await request('GET', '/dashboard/admin');
                if (response.code === 401 || response.code === 302) {
                    updateTestResult('unauthRedirect', 'pass', 'âœ… æœªç™»å½•æ—¶æ­£ç¡®é˜»æ­¢è®¿é—®');
                } else {
                    updateTestResult('unauthRedirect', 'fail', 'âŒ æœªç™»å½•è®¿é—®æœªè¢«é˜»æ­¢');
                }
            } catch (error) {
                if (error.message.includes('401') || error.message.includes('302')) {
                    updateTestResult('unauthRedirect', 'pass', 'âœ… æœªç™»å½•æ—¶æ­£ç¡®é˜»æ­¢è®¿é—®');
                } else {
                    updateTestResult('unauthRedirect', 'fail', 'âŒ è®¿é—®æ§åˆ¶å¤±è´¥: ' + error.message);
                }
            }
        }

        // æµ‹è¯•ä¿æŠ¤é¡µé¢è®¿é—®
        async function testProtectedAccess() {
            try {
                // æµ‹è¯•ä¸åŒè§’è‰²çš„ä»ªè¡¨æ¿è®¿é—®
                const dashboards = [
                    { path: '/dashboard/admin', role: 'ADMIN' },
                    { path: '/dashboard/personal', role: 'PERSONAL_USER' },
                    { path: '/dashboard/enterprise', role: 'ENTERPRISE_USER' },
                    { path: '/dashboard/airline', role: 'AIRLINE_USER' }
                ];

                let result = '';
                for (const dash of dashboards) {
                    const response = await request('GET', dash.path);
                    result += `ğŸ“ ${dash.path} (${dash.role}): ${response.code === 401 ? 'éœ€è¦ç™»å½• âœ…' : 'æ— éœ€ç™»å½• âš ï¸'}\n`;
                }

                document.getElementById('redirectResult').className = 'result info';
                document.getElementById('redirectResult').textContent = result;
            } catch (error) {
                document.getElementById('redirectResult').className = 'result error';
                document.getElementById('redirectResult').textContent = 'âŒ æµ‹è¯•å¤±è´¥: ' + error.message;
            }
        }

        // æµ‹è¯•SSOç™»å½•
        function testSsoLogin() {
            const returnUrl = encodeURIComponent(window.location.href);
            const ssoUrl = `http://localhost:8081/sso/auth?redirect=${encodeURIComponent(window.location.origin + '/callback')}&return_url=${returnUrl}`;

            updateTestResult('ssoLogin', 'running', 'æ­£åœ¨æµ‹è¯•...');

            document.getElementById('loginResult').className = 'result success';
            document.getElementById('loginResult').textContent = `ğŸ”— SSOç™»å½•URL: ${ssoUrl}\n\nè¯·åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ä¸Šè¿°URLè¿›è¡Œæµ‹è¯•`;

            updateTestResult('ssoLogin', 'pass', 'âœ… SSOç™»å½•URLç”Ÿæˆæ­£ç¡®');
        }

        // æµ‹è¯•å›è°ƒå¤„ç†
        async function testCallback() {
            try {
                // æ¨¡æ‹ŸticketéªŒè¯
                const mockTicket = 'test_ticket_' + Date.now();
                const response = await request('POST', 'http://localhost:8081/sso/validate', null, {
                    params: { ticket: mockTicket }
                });

                if (response.code === 200) {
                    document.getElementById('loginResult').className = 'result success';
                    document.getElementById('loginResult').textContent = 'âœ… TicketéªŒè¯æ¥å£æ­£å¸¸';
                } else {
                    document.getElementById('loginResult').className = 'result warning';
                    document.getElementById('loginResult').textContent = 'âš ï¸ TicketéªŒè¯è¿”å›: ' + response.message;
                }
            } catch (error) {
                document.getElementById('loginResult').className = 'result error';
                document.getElementById('loginResult').textContent = 'âŒ å›è°ƒæµ‹è¯•å¤±è´¥: ' + error.message;
            }
        }

        // æµ‹è¯•ä¼šè¯åŒæ­¥
        async function testSessionSync() {
            updateTestResult('sessionSync', 'running', 'æ­£åœ¨æµ‹è¯•...');
            try {
                const response = await request('GET', '/sso/check-login');
                if (response.code === 200) {
                    updateTestResult('sessionSync', 'pass', 'âœ… ä¼šè¯çŠ¶æ€æ£€æŸ¥æ­£å¸¸');
                } else {
                    updateTestResult('sessionSync', 'fail', 'âŒ ä¼šè¯çŠ¶æ€æ£€æŸ¥å¤±è´¥');
                }
            } catch (error) {
                updateTestResult('sessionSync', 'fail', 'âŒ ä¼šè¯åŒæ­¥æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // æµ‹è¯•å¤šæ ‡ç­¾ç™»å½•
        function testMultiTabLogin() {
            const message = `ğŸ”„ å¤šæ ‡ç­¾ç™»å½•æµ‹è¯•è¯´æ˜:
1. åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€: http://localhost:5137
2. åœ¨æ–°æ ‡ç­¾é¡µä¸­ç™»å½•
3. å›åˆ°å½“å‰æ ‡ç­¾é¡µï¼Œç‚¹å‡»"æµ‹è¯•ä¼šè¯åŒæ­¥"
4. è§‚å¯Ÿæ˜¯å¦è‡ªåŠ¨è·å–åˆ°ç™»å½•çŠ¶æ€

å½“å‰æ ‡ç­¾é¡µåº”èƒ½æ£€æµ‹åˆ°å…¶ä»–æ ‡ç­¾é¡µçš„ç™»å½•çŠ¶æ€`;
            document.getElementById('sessionResult').className = 'result info';
            document.getElementById('sessionResult').textContent = message;
        }

        // æµ‹è¯•å•ç‚¹æ³¨é”€
        async function testSlo() {
            updateTestResult('slo', 'running', 'æ­£åœ¨æµ‹è¯•...');
            try {
                const response = await request('POST', '/sso/logout');
                if (response.code === 200) {
                    updateTestResult('slo', 'pass', 'âœ… å•ç‚¹æ³¨é”€æ¥å£æ­£å¸¸');
                } else {
                    updateTestResult('slo', 'fail', 'âŒ å•ç‚¹æ³¨é”€å¤±è´¥: ' + response.message);
                }
            } catch (error) {
                updateTestResult('slo', 'fail', 'âŒ å•ç‚¹æ³¨é”€æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // æµ‹è¯•ç”¨æˆ·ç±»å‹
        async function testUserTypes() {
            updateTestResult('userTypes', 'running', 'æ­£åœ¨æµ‹è¯•...');
            try {
                // æµ‹è¯•è§’è‰²æƒé™è·å–
                const response = await request('GET', '/api/role/current');
                if (response.code === 200) {
                    const roles = response.data.roles || [];
                    const primaryRole = response.data.primaryRole || 'unknown';

                    let result = `å½“å‰ç”¨æˆ·è§’è‰²: ${JSON.stringify(roles)}\n`;
                    result += `ä¸»è¦è§’è‰²: ${primaryRole}\n\n`;

                    // æ£€æŸ¥è§’è‰²å¯¹åº”çš„ä»ªè¡¨æ¿è·¯å¾„
                    const roleDashboards = {
                        'ADMIN': '/dashboard/admin',
                        'PERSONAL_USER': '/dashboard/personal',
                        'ENTERPRISE_USER': '/dashboard/enterprise',
                        'AIRLINE_USER': '/dashboard/airline'
                    };

                    for (const role of roles) {
                        const dashboard = roleDashboards[role];
                        result += `ğŸ“ ${role} â†’ ${dashboard || 'æ— å¯¹åº”ä»ªè¡¨æ¿'}\n`;
                    }

                    updateTestResult('userTypes', 'pass', result);
                } else {
                    updateTestResult('userTypes', 'fail', 'âŒ è·å–è§’è‰²ä¿¡æ¯å¤±è´¥');
                }
            } catch (error) {
                updateTestResult('userTypes', 'fail', 'âŒ ç”¨æˆ·ç±»å‹æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // æµ‹è¯•è§’è‰²æƒé™
        async function testRolePermissions() {
            try {
                const permissions = [
                    'user:profile:view',
                    'system:user:view',
                    'enterprise:info:view',
                    'airline:flight:view'
                ];

                let result = 'æƒé™æ£€æŸ¥ç»“æœ:\n\n';
                for (const perm of permissions) {
                    const response = await request('POST', '/api/role/check-permission', { permission: perm });
                    const hasPerm = response.code === 200 && response.data === true;
                    result += `${hasPerm ? 'âœ…' : 'âŒ'} ${perm}\n`;
                }

                document.getElementById('userTypeResult').className = 'result info';
                document.getElementById('userTypeResult').textContent = result;
            } catch (error) {
                document.getElementById('userTypeResult').className = 'result error';
                document.getElementById('userTypeResult').textContent = 'âŒ æƒé™æ£€æŸ¥å¤±è´¥: ' + error.message;
            }
        }

        // æµ‹è¯•Tokenç®¡ç†
        async function testTokenManagement() {
            updateTestResult('tokenManagement', 'running', 'æ­£åœ¨æµ‹è¯•...');
            try {
                // æµ‹è¯•TokenéªŒè¯
                const verifyResponse = await request('GET', '/sso/verify');
                if (verifyResponse.code === 200) {
                    updateTestResult('tokenManagement', 'pass', 'âœ… TokenéªŒè¯æ­£å¸¸');
                } else {
                    updateTestResult('tokenManagement', 'fail', 'âŒ TokenéªŒè¯å¤±è´¥');
                }
            } catch (error) {
                updateTestResult('tokenManagement', 'fail', 'âŒ Tokenç®¡ç†æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // æµ‹è¯•Tokenè¿‡æœŸ
        function testTokenExpiry() {
            const message = `â° Tokenè¿‡æœŸæµ‹è¯•è¯´æ˜:
1. ç™»å½•ç³»ç»Ÿ
2. ç­‰å¾…Tokenè¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤30å¤©ï¼‰
3. å°è¯•è®¿é—®å—ä¿æŠ¤èµ„æº
4. è§‚å¯Ÿæ˜¯å¦è‡ªåŠ¨è·³è½¬ç™»å½•

æˆ–è€…æ‰‹åŠ¨ä¿®æ”¹Tokenè¿‡æœŸæ—¶é—´è¿›è¡Œæµ‹è¯•`;
            document.getElementById('tokenResult').className = 'result info';
            document.getElementById('tokenResult').textContent = message;
        }

        // æ¸…é™¤æ‰€æœ‰è®¤è¯çŠ¶æ€
        function clearAllAuth() {
            try {
                localStorage.clear();
                document.cookie.split(";").forEach(function(c) {
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                });
                document.getElementById('maintenanceResult').className = 'result success';
                document.getElementById('maintenanceResult').textContent = 'âœ… æ‰€æœ‰è®¤è¯çŠ¶æ€å·²æ¸…é™¤';
            } catch (error) {
                document.getElementById('maintenanceResult').className = 'result error';
                document.getElementById('maintenanceResult').textContent = 'âŒ æ¸…é™¤å¤±è´¥: ' + error.message;
            }
        }

        // æ¸…é™¤ç¼“å­˜
        async function clearCache() {
            try {
                // æ¸…é™¤Redisç¼“å­˜ï¼ˆéœ€è¦åç«¯æ”¯æŒï¼‰
                const response = await request('POST', '/api/cache/clear');
                if (response.code === 200) {
                    document.getElementById('maintenanceResult').className = 'result success';
                    document.getElementById('maintenanceResult').textContent = 'âœ… ç¼“å­˜å·²æ¸…é™¤';
                } else {
                    document.getElementById('maintenanceResult').className = 'result warning';
                    document.getElementById('maintenanceResult').textContent = 'âš ï¸ ç¼“å­˜æ¸…é™¤æ¥å£æœªå®ç°';
                }
            } catch (error) {
                document.getElementById('maintenanceResult').className = 'result error';
                document.getElementById('maintenanceResult').textContent = 'âŒ ç¼“å­˜æ¸…é™¤å¤±è´¥: ' + error.message;
            }
        }

        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        function showDebugInfo() {
            const debug = {
                timestamp: new Date().toISOString(),
                url: window.location.href,
                cookies: document.cookie,
                localStorage: Object.keys(localStorage),
                sessionStorage: Object.keys(sessionStorage),
                userAgent: navigator.userAgent,
                testResults: testResults
            };

            document.getElementById('maintenanceResult').className = 'result info';
            document.getElementById('maintenanceResult').textContent = JSON.stringify(debug, null, 2);
        }

        // æ›´æ–°æµ‹è¯•ç»“æœ
        function updateTestResult(testName, status, message) {
            testResults[testName] = { status, message };
            updateTestReport();
        }

        // æ›´æ–°æµ‹è¯•æŠ¥å‘Š
        function updateTestReport() {
            let report = 'ğŸ“Š SSOç³»ç»Ÿæµ‹è¯•æŠ¥å‘Š\n\n';
            report += 'æµ‹è¯•æ—¶é—´: ' + new Date().toLocaleString() + '\n\n';

            const statusMap = {
                pass: 'âœ… é€šè¿‡',
                fail: 'âŒ å¤±è´¥',
                pending: 'â³ å¾…æµ‹è¯•',
                running: 'ğŸ”„ è¿è¡Œä¸­'
            };

            for (const [testName, result] of Object.entries(testResults)) {
                const statusText = statusMap[result.status] || result.status;
                report += `${testName}: ${statusText}\n`;
                if (result.message) {
                    report += `   ${result.message}\n`;
                }
                report += '\n';
            }

            document.getElementById('testReport').textContent = report;
        }

        // é¡µé¢åˆå§‹åŒ–
        window.onload = function() {
            showEnvInfo();
            updateTestReport();
        };

        // å®šæœŸæ£€æŸ¥ç™»å½•çŠ¶æ€
        setInterval(async () => {
            if (document.getElementById('sessionResult').classList.contains('success')) {
                await testSessionSync();
            }
        }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
    </script>
</body>
</html>
